<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PostStudio I.A - Editar V√≠deo</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=Poppins:wght@300;400;500;600;700;800;900&family=Playfair+Display:wght@400;500;600;700;800;900&family=Montserrat:wght@300;400;500;600;700;800;900&family=Roboto:wght@300;400;500;700;900&family=Open+Sans:wght@300;400;600;700;800&family=Lato:wght@300;400;700;900&family=Source+Sans+Pro:wght@300;400;600;700;900&family=Nunito:wght@300;400;600;700;800;900&family=Quicksand:wght@300;400;500;600;700&family=Raleway:wght@300;400;500;600;700;800;900&family=Abril+Fatface&family=Merriweather:wght@300;400;700;900&family=PT+Serif:wght@400;700&family=Work+Sans:wght@300;400;600;700;800&family=Oswald:wght@300;400;500;600;700&family=Lobster&family=Pacifico&family=Dancing+Script:wght@400;500;600;700&family=Great+Vibes&family=Satisfy&family=Ubuntu:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .glass-effect {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        /* Cursor branco para todos os inputs */
        input, textarea, select {
            caret-color: white !important;
            color: white !important;
            background-color: rgba(255, 255, 255, 0.1) !important;
        }
        
        /* For√ßar cursor branco em todos os navegadores */
        input:focus, textarea:focus, select:focus {
            caret-color: white !important;
            color: white !important;
            background-color: rgba(255, 255, 255, 0.2) !important;
        }
        
        /* Garantir que o texto seja branco e vis√≠vel */
        input, textarea, select {
            color: white !important;
            text-shadow: 0 0 2px rgba(0, 0, 0, 0.5) !important;
        }
        
        /* Placeholder branco com sombra */
        input::placeholder, textarea::placeholder {
            color: rgba(255, 255, 255, 0.8) !important;
            text-shadow: 0 0 2px rgba(0, 0, 0, 0.5) !important;
        }
        
        /* Garantir que o texto digitado seja sempre vis√≠vel */
        input:not(:placeholder-shown), textarea:not(:placeholder-shown) {
            color: white !important;
            text-shadow: 0 0 3px rgba(0, 0, 0, 0.8) !important;
            font-weight: 500 !important;
        }
    </style>
</head>
<body class="gradient-bg min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="flex items-center justify-between mb-8">
                <div class="flex items-center space-x-4">
                <button onclick="window.location.href='/create-post'" class="text-white hover:text-white/80 transition-colors">
                    <i class="fas fa-arrow-left text-xl"></i>
                    </button>
                <h1 class="text-3xl font-bold text-white">
                    <i class="fas fa-video mr-3"></i>Editar V√≠deo
                </h1>
            </div>
        </div>

        <!-- Video Upload Section -->
        <div class="glass-effect rounded-2xl p-8 mb-8">
            <h2 class="text-2xl font-bold text-white mb-6">
                <i class="fas fa-upload mr-3"></i>Upload de V√≠deo
            </h2>
            
            <div class="border-2 border-dashed border-white/30 rounded-lg p-8 text-center hover:border-white/50 transition-colors">
                <input 
                    type="file" 
                    id="videoUpload" 
                    accept="video/*" 
                    class="hidden"
                    onchange="handleVideoUpload(event)"
                >
                <label for="videoUpload" class="cursor-pointer">
                    <i class="fas fa-video text-6xl text-white/60 mb-4"></i>
                    <p class="text-white/80 text-xl mb-2">Clique para selecionar v√≠deo</p>
                    <p class="text-white/60">MP4, AVI, MOV at√© 100MB</p>
                </label>
            </div>
            
            <div id="videoPreview" class="mt-6">
                <!-- Preview do v√≠deo ser√° inserido aqui -->
            </div>
        </div>

        <!-- Pexels Videos Section -->
        <div class="glass-effect rounded-2xl p-8 mb-8">
            <h2 class="text-2xl font-bold text-white mb-6">
                <i class="fas fa-video mr-3"></i>V√≠deos Profissionais
            </h2>
            
            <!-- Search and Categories -->
                <div class="mb-6">
                <div class="flex space-x-2 mb-4">
                    <input type="text" id="pexelsVideoSearch" placeholder="Buscar v√≠deos..." 
                           class="flex-1 px-4 py-2 rounded-lg bg-white/10 border border-white/20 text-white placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-orange-400/50">
                    <button onclick="searchPexelsVideos()" class="bg-orange-500/20 text-orange-300 px-4 py-2 rounded-lg hover:bg-orange-500/30 transition-colors">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
                
                <div class="flex flex-wrap gap-2">
                    <button onclick="loadModernVideoCategory('technology modern digital')" class="category-btn px-3 py-1 rounded-full bg-white/10 text-white text-sm hover:bg-white/20 transition-colors">
                        üíª Tecnologia
                    </button>
                    <button onclick="loadModernVideoCategory('modern city urban architecture')" class="category-btn px-3 py-1 rounded-full bg-white/10 text-white text-sm hover:bg-white/20 transition-colors">
                        üèôÔ∏è Cidade
                    </button>
                    <button onclick="loadModernVideoCategory('business corporate office modern')" class="category-btn px-3 py-1 rounded-full bg-white/10 text-white text-sm hover:bg-white/20 transition-colors">
                        üíº Neg√≥cios
                    </button>
                    <button onclick="loadModernVideoCategory('lifestyle modern fashion')" class="category-btn px-3 py-1 rounded-full bg-white/10 text-white text-sm hover:bg-white/20 transition-colors">
                        üëî Lifestyle
                    </button>
                    <button onclick="loadModernVideoCategory('sports fitness modern gym')" class="category-btn px-3 py-1 rounded-full bg-white/10 text-white text-sm hover:bg-white/20 transition-colors">
                        üèÉ Esportes
                    </button>
                    <button onclick="loadModernVideoCategory('food modern restaurant cuisine')" class="category-btn px-3 py-1 rounded-full bg-white/10 text-white text-sm hover:bg-white/20 transition-colors">
                        üçΩÔ∏è Comida
                    </button>
                </div>
                    </div>
                    
            <!-- Videos Grid -->
            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 max-h-96 overflow-y-auto" id="pexelsVideosList">
                <div class="col-span-full text-center text-white/60 py-8">
                    <i class="fas fa-video text-4xl mb-2"></i>
                    <p>Digite algo para buscar ou escolha uma categoria</p>
                </div>
            </div>
                    </div>
                    
        <!-- Video Editing Tools -->
        <div class="glass-effect rounded-2xl p-8 mb-8">
            <h2 class="text-2xl font-bold text-white mb-6">
                <i class="fas fa-edit mr-3"></i>Ferramentas de Edi√ß√£o
            </h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Video Caption -->
                <div class="bg-white/5 rounded-lg p-6">
                    <h3 class="text-lg font-semibold text-white mb-4">
                        <i class="fas fa-closed-captioning mr-2"></i>Legenda do V√≠deo
                    </h3>
                    <div class="space-y-4">
                        <div>
                            <label for="videoCaption" class="block text-sm font-medium text-white mb-2">
                                Texto da Legenda
                            </label>
                            <textarea 
                                id="videoCaption" 
                                rows="3"
                                class="w-full px-4 py-3 rounded-lg bg-white/20 border border-white/30 text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-white/50 focus:border-transparent transition-all duration-300"
                                placeholder="Digite a legenda que aparecer√° no v√≠deo..."
                            ></textarea>
                        </div>
                        <div>
                            <label for="videoCaptionFont" class="block text-sm font-medium text-white mb-2">
                                Fonte da Legenda
                            </label>
                            <select 
                                id="videoCaptionFont" 
                                class="w-full px-4 py-3 rounded-lg bg-white/20 border border-white/30 text-white focus:outline-none focus:ring-2 focus:ring-white/50 focus:border-transparent transition-all duration-300"
                            >
                                <option value="font-inter">Inter</option>
                                <option value="font-roboto">Roboto</option>
                                <option value="font-open-sans">Open Sans</option>
                                <option value="font-montserrat">Montserrat</option>
                            </select>
                    </div>
                    </div>
                </div>

                <!-- Video Effects -->
                <div class="bg-white/5 rounded-lg p-6">
                    <h3 class="text-lg font-semibold text-white mb-4">
                        <i class="fas fa-magic mr-2"></i>Efeitos do V√≠deo
                    </h3>
                    <div class="space-y-4">
                        <div>
                            <label for="videoSpeed" class="block text-sm font-medium text-white mb-2">
                                Velocidade do V√≠deo
                            </label>
                            <select 
                                id="videoSpeed" 
                                class="w-full px-4 py-3 rounded-lg bg-white/20 border border-white/30 text-white focus:outline-none focus:ring-2 focus:ring-white/50 focus:border-transparent transition-all duration-300"
                            >
                                <option value="0.5">0.5x (Lento)</option>
                                <option value="0.75">0.75x</option>
                                <option value="1" selected>1x (Normal)</option>
                                <option value="1.25">1.25x</option>
                                <option value="1.5">1.5x</option>
                                <option value="2">2x (R√°pido)</option>
                            </select>
                    </div>
                        <div>
                            <label for="videoFilter" class="block text-sm font-medium text-white mb-2">
                                Filtro do V√≠deo
                            </label>
                            <select 
                                id="videoFilter" 
                                class="w-full px-4 py-3 rounded-lg bg-white/20 border border-white/30 text-white focus:outline-none focus:ring-2 focus:ring-white/50 focus:border-transparent transition-all duration-300"
                            >
                                <option value="none">Nenhum</option>
                                <option value="grayscale">Preto e Branco</option>
                                <option value="sepia">S√©pia</option>
                                <option value="brightness">Brilho</option>
                                <option value="contrast">Contraste</option>
                            </select>
                    </div>
                    </div>
                </div>
            </div>
                </div>

        <!-- Narra√ß√£o com Vozes ElevenLabs -->
        <div class="glass-effect rounded-2xl p-8 mb-8">
            <h2 class="text-2xl font-bold text-white mb-6">
                <i class="fas fa-microphone mr-3"></i>Narra√ß√£o com Vozes Premium
            </h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Texto da Narra√ß√£o -->
                <div class="bg-white/5 rounded-lg p-6">
                    <h3 class="text-lg font-semibold text-white mb-4">
                        <i class="fas fa-edit mr-2"></i>Texto da Narra√ß√£o
                    </h3>
                    <div class="space-y-4">
                        <div>
                            <label for="narrationText" class="block text-sm font-medium text-white mb-2">
                                Texto para Narra√ß√£o
                            </label>
                            <textarea 
                                id="narrationText" 
                                rows="4"
                                class="w-full px-4 py-3 rounded-lg bg-white/20 border border-white/30 text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-white/50 focus:border-transparent transition-all duration-300"
                                placeholder="Digite o texto que ser√° narrado no v√≠deo..."
                            ></textarea>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="narrationSpeed" class="block text-sm font-medium text-white mb-2">
                                    Velocidade
                                </label>
                                <select 
                                    id="narrationSpeed" 
                                    class="w-full px-4 py-3 rounded-lg bg-white/20 border border-white/30 text-white focus:outline-none focus:ring-2 focus:ring-white/50 focus:border-transparent transition-all duration-300"
                                >
                                    <option value="0.8">Lenta (0.8x)</option>
                                    <option value="1.0" selected>Normal (1.0x)</option>
                                    <option value="1.2">R√°pida (1.2x)</option>
                                </select>
                            </div>
                            <div>
                                <label for="narrationVolume" class="block text-sm font-medium text-white mb-2">
                                    Volume
                                </label>
                                <select 
                                    id="narrationVolume" 
                                    class="w-full px-4 py-3 rounded-lg bg-white/20 border border-white/30 text-white focus:outline-none focus:ring-2 focus:ring-white/50 focus:border-transparent transition-all duration-300"
                                >
                                    <option value="0.5">Baixo</option>
                                    <option value="0.8" selected>M√©dio</option>
                                    <option value="1.0">Alto</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sele√ß√£o de Vozes -->
                <div class="bg-white/5 rounded-lg p-6">
                    <h3 class="text-lg font-semibold text-white mb-4">
                        <i class="fas fa-microphone mr-2"></i>Vozes ElevenLabs
                    </h3>
                    <div class="space-y-4">
                        <div>
                            <label for="voiceSelect" class="block text-sm font-medium text-white mb-2">
                                Selecione uma Voz
                            </label>
                            <select 
                                id="voiceSelect" 
                                class="w-full px-4 py-3 rounded-lg bg-white/20 border border-white/30 text-white focus:outline-none focus:ring-2 focus:ring-white/50 focus:border-transparent transition-all duration-300"
                            >
                                <option value="">Carregando vozes...</option>
                            </select>
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="testAudio()" class="bg-purple-500/20 text-purple-300 px-3 py-2 rounded-lg hover:bg-purple-500/30 transition-colors">
                                <i class="fas fa-volume-up mr-1"></i>Teste
                            </button>
                            <button onclick="previewVoice()" class="flex-1 bg-blue-500/20 text-blue-300 px-4 py-2 rounded-lg hover:bg-blue-500/30 transition-colors">
                                <i class="fas fa-play mr-2"></i>Preview
                            </button>
                            <button onclick="generateNarration()" class="flex-1 bg-green-500/20 text-green-300 px-4 py-2 rounded-lg hover:bg-green-500/30 transition-colors">
                                <i class="fas fa-microphone mr-2"></i>Gerar
                            </button>
                        </div>
                        <div id="narrationStatus" class="text-white/60 text-sm">
                            <!-- Status ser√° exibido aqui -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Actions -->
        <div class="glass-effect rounded-2xl p-8">
            <div class="flex justify-between items-center">
                <button onclick="window.location.href='/create-post'" class="bg-white/10 text-white px-6 py-3 rounded-lg hover:bg-white/20 transition-colors">
                    <i class="fas fa-arrow-left mr-2"></i>Voltar
                </button>
                <button onclick="saveVideo()" class="bg-green-500/20 text-green-300 px-6 py-3 rounded-lg hover:bg-green-500/30 transition-colors">
                    <i class="fas fa-save mr-2"></i>Salvar V√≠deo
                </button>
            </div>
        </div>
        </div>

    <script src="text-to-speech.js"></script>
    <script>
        let selectedVideo = null;
        let pexelsManager = null;
        let ttsManager = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            pexelsManager = new ModernVideosManager();
            
            // Inicializar TTS Manager
            try {
                ttsManager = new TextToSpeechManager();
                loadVoices();
            } catch (error) {
                console.error('Erro ao inicializar TTS Manager:', error);
                updateNarrationStatus('Erro ao inicializar sistema de vozes', 'error');
            }
        });

        // Fun√ß√µes de Narra√ß√£o
        async function loadVoices() {
            try {
                console.log('üîÑ Carregando vozes da ElevenLabs...');
                console.log('üîç TTS Manager:', ttsManager);
                
                if (!ttsManager) {
                    console.error('‚ùå TTS Manager n√£o inicializado!');
                    updateNarrationStatus('Erro: TTS Manager n√£o inicializado', 'error');
                    return;
                }
                
                await ttsManager.loadVoices();
                const voiceSelect = document.getElementById('voiceSelect');
                
                console.log('üìä Vozes carregadas:', ttsManager.voices.length);
                console.log('üé§ Primeiras vozes:', ttsManager.voices.slice(0, 3));
                
                if (ttsManager.voices.length > 0) {
                    voiceSelect.innerHTML = '<option value="">Selecione uma voz...</option>';
                    
                    console.log('üîç Debug - Vozes dispon√≠veis:');
                    ttsManager.voices.forEach((voice, index) => {
                        console.log(`üé§ Voz ${index + 1}:`, {
                            id: voice.voice_id,
                            name: voice.name,
                            category: voice.category
                        });
                        
                        const option = document.createElement('option');
                        option.value = voice.voice_id;
                        option.textContent = `${voice.name} (${voice.category || 'geral'})`;
                        voiceSelect.appendChild(option);
                        
                        // Selecionar a primeira voz automaticamente
                        if (index === 0) {
                            voiceSelect.value = voice.voice_id;
                        }
                    });
                    
                    console.log('‚úÖ Vozes carregadas:', ttsManager.voices.length);
                    console.log('üîç Debug - Op√ß√µes no select:', voiceSelect.options.length);
                    updateNarrationStatus(`‚úÖ ${ttsManager.voices.length} vozes carregadas!`, 'success');
                } else {
                    voiceSelect.innerHTML = '<option value="">Nenhuma voz dispon√≠vel</option>';
                    updateNarrationStatus('‚ùå Nenhuma voz encontrada', 'error');
                }
            } catch (error) {
                console.error('‚ùå Erro ao carregar vozes:', error);
                const voiceSelect = document.getElementById('voiceSelect');
                voiceSelect.innerHTML = '<option value="">Erro ao carregar vozes</option>';
                updateNarrationStatus('‚ùå Erro ao carregar vozes: ' + error.message, 'error');
            }
        }

        async function previewVoice() {
            const text = document.getElementById('narrationText').value;
            const voiceId = document.getElementById('voiceSelect').value;
            
            if (!text.trim()) {
                alert('Digite um texto para a narra√ß√£o!');
                return;
            }
            
            if (!voiceId) {
                alert('Selecione uma voz!');
                return;
            }
            
            updateNarrationStatus('Gerando preview da voz...', 'loading');
            
            try {
                const options = {
                    stability: 0.5,
                    similarityBoost: 0.5,
                    style: 0.0,
                    useSpeakerBoost: true
                };
                
                const audioBlob = await ttsManager.generateSpeech(text, voiceId, options);
                
                // Usar a fun√ß√£o playSpeech do TTS Manager
                const audio = await ttsManager.playSpeech(audioBlob);
                
                // Aguardar o √°udio terminar
                audio.addEventListener('ended', () => {
                    updateNarrationStatus('‚úÖ Preview reproduzido!', 'success');
                });
                
                audio.addEventListener('error', (error) => {
                    console.error('Erro ao reproduzir √°udio:', error);
                    updateNarrationStatus('‚ùå Erro ao reproduzir √°udio', 'error');
                });
                
            } catch (error) {
                console.error('Erro ao gerar preview:', error);
                updateNarrationStatus('‚ùå Erro ao gerar preview: ' + error.message, 'error');
            }
        }

        async function generateNarration() {
            const text = document.getElementById('narrationText').value;
            const voiceId = document.getElementById('voiceSelect').value;
            const speed = document.getElementById('narrationSpeed').value;
            const volume = document.getElementById('narrationVolume').value;
            
            if (!text.trim()) {
                alert('Digite um texto para a narra√ß√£o!');
                return;
            }
            
            if (!voiceId) {
                alert('Selecione uma voz!');
                return;
            }
            
            updateNarrationStatus('Gerando narra√ß√£o...', 'loading');
            
            try {
                const options = {
                    stability: 0.5,
                    similarityBoost: 0.5,
                    style: 0.0,
                    useSpeakerBoost: true
                };
                
                const audioBlob = await ttsManager.generateSpeech(text, voiceId, options);
                
                // Salvar narra√ß√£o para uso posterior
                window.generatedNarration = audioBlob;
                
                updateNarrationStatus('‚úÖ Narra√ß√£o gerada com sucesso!', 'success');
                
                // Mostrar op√ß√µes de download
                const statusDiv = document.getElementById('narrationStatus');
                statusDiv.innerHTML += `
                    <div class="mt-2">
                        <button onclick="downloadNarration()" class="bg-green-500/20 text-green-300 px-3 py-1 rounded text-sm hover:bg-green-500/30">
                            <i class="fas fa-download mr-1"></i>Baixar √Åudio
                        </button>
                    </div>
                `;
                
            } catch (error) {
                console.error('Erro ao gerar narra√ß√£o:', error);
                updateNarrationStatus('‚ùå Erro ao gerar narra√ß√£o: ' + error.message, 'error');
            }
        }

        function downloadNarration() {
            if (window.generatedNarration) {
                const url = URL.createObjectURL(window.generatedNarration);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'narracao-video.mp3';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }
        }

        function updateNarrationStatus(message, type) {
            const statusDiv = document.getElementById('narrationStatus');
            const icon = type === 'loading' ? 'fas fa-spinner fa-spin' : 
                        type === 'success' ? 'fas fa-check-circle' : 'fas fa-exclamation-triangle';
            const color = type === 'loading' ? 'text-blue-400' : 
                         type === 'success' ? 'text-green-400' : 'text-red-400';
            
            statusDiv.innerHTML = `
                <div class="flex items-center">
                    <i class="${icon} ${color} mr-2"></i>
                    <span>${message}</span>
                </div>
            `;
        }

        // Fun√ß√£o para testar √°udio
        function testAudio() {
            console.log('üîä Testando reprodu√ß√£o de √°udio...');
            
            // Criar um √°udio de teste simples
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.setValueAtTime(440, audioContext.currentTime);
            gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.5);
            
            console.log('‚úÖ Teste de √°udio conclu√≠do');
            updateNarrationStatus('‚úÖ Sistema de √°udio funcionando', 'success');
        }

        // Pexels Manager Class
        class ModernVideosManager {
            constructor() {
                this.accessKey = 'f0djuVMOG9iW68zHOsbZmk2yt5ip7wbajvoPz10jMOhVDtg7yihzmRjJ';
                this.baseURL = 'https://api.pexels.com/v1';
                this.cache = new Map();
                this.cacheTimeout = 10 * 60 * 1000; // 10 minutos
            }

            // Cache com timeout
            getCachedData(key) {
                const cached = this.cache.get(key);
                if (cached && Date.now() - cached.timestamp < this.cacheTimeout) {
                    return cached.data;
                }
                this.cache.delete(key);
                return null;
            }

            setCachedData(key, data) {
                this.cache.set(key, {
                    data: data,
                    timestamp: Date.now()
                });
            }

            async searchVideos(query, page = 1) {
                const cacheKey = `search_${query}_${page}`;
                const cached = this.getCachedData(cacheKey);
                if (cached) {
                    console.log('üì¶ V√≠deos carregados do cache');
                    return cached;
                }

                try {
                    const response = await fetch(
                        `${this.baseURL}/videos/search?query=${encodeURIComponent(query)}&page=${page}&per_page=12&orientation=landscape&size=large`,
                        {
                            headers: {
                                'Authorization': this.accessKey
                            }
                        }
                    );
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    const result = {
                        videos: data.videos,
                        total: data.total_results
                    };
                    
                    // Salvar no cache
                    this.setCachedData(cacheKey, result);
                    return result;
                } catch (error) {
                    console.error('‚ùå Erro ao buscar v√≠deos do Pexels:', error);
                    return { videos: [], total: 0 };
                }
            }

            async getVideosByCategory(category, page = 1) {
                const categories = {
                    'technology modern digital': 'technology modern digital',
                    'modern city urban architecture': 'modern city urban architecture',
                    'business corporate office modern': 'business corporate office modern',
                    'lifestyle modern fashion': 'lifestyle modern fashion',
                    'sports fitness modern gym': 'sports fitness modern gym',
                    'food modern restaurant cuisine': 'food modern restaurant cuisine'
                };

                const query = categories[category] || category;
                return await this.searchVideos(query, page);
            }
        }

        // Handle Video Upload
        function handleVideoUpload(event) {
            const file = event.target.files[0];
            if (file) {
                selectedVideo = file;
                displayVideoPreview();
            }
        }

        // Display Video Preview
        function displayVideoPreview() {
            const previewContainer = document.getElementById('videoPreview');
            
            if (selectedVideo) {
                // Verificar se √© um File (upload local) ou um objeto com URL (Pexels)
                if (selectedVideo instanceof File) {
                    // Upload local - usar FileReader
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        previewContainer.innerHTML = `
                            <div class="relative">
                                <video src="${e.target.result}" class="w-full h-64 object-cover rounded-lg border border-white/20" controls>
                                    Seu navegador n√£o suporta v√≠deos.
                                </video>
                                <div class="absolute top-4 right-4 bg-black/50 text-white px-3 py-1 rounded-full text-sm">
                                    ${selectedVideo.name}
                                </div>
                                <button type="button" onclick="removeVideo()" class="absolute top-4 left-4 bg-red-500 text-white rounded-full w-8 h-8 flex items-center justify-center text-sm hover:bg-red-600">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        `;
                    };
                    reader.readAsDataURL(selectedVideo);
                } else if (selectedVideo.url) {
                    // V√≠deo do Pexels - usar URL diretamente
                    previewContainer.innerHTML = `
                        <div class="relative">
                            <video src="${selectedVideo.url}" class="w-full h-64 object-cover rounded-lg border border-white/20" controls>
                                Seu navegador n√£o suporta v√≠deos.
                            </video>
                            <!-- Bot√£o de remover -->
                            <button type="button" onclick="removeVideo()" class="absolute top-2 right-2 bg-red-500 text-white rounded-full w-8 h-8 flex items-center justify-center text-sm hover:bg-red-600">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    `;
                }
            } else {
                previewContainer.innerHTML = '';
            }
        }

        // Remove Video
        function removeVideo() {
            selectedVideo = null;
            document.getElementById('videoUpload').value = '';
            document.getElementById('videoPreview').innerHTML = '';
        }

        // Search Pexels Videos
        async function searchPexelsVideos() {
            const query = document.getElementById('pexelsVideoSearch').value;
            if (query.trim() && pexelsManager) {
                const result = await pexelsManager.searchVideos(query);
                displayPexelsVideos(result.videos);
            }
        }

        // Load Modern Video Category
        async function loadModernVideoCategory(category) {
            if (pexelsManager) {
                const result = await pexelsManager.getVideosByCategory(category);
                displayPexelsVideos(result.videos);
            }
        }

        // Load Pexels Video Category (legacy)
        async function loadPexelsVideoCategory(category) {
            if (pexelsManager) {
                const result = await pexelsManager.getVideosByCategory(category);
                displayPexelsVideos(result.videos);
            }
        }

        // Display Pexels Videos
        function displayPexelsVideos(videos) {
            const container = document.getElementById('pexelsVideosList');
            if (!container) return;

            container.innerHTML = videos.map(video => `
                <div class="pexels-video-card bg-white/5 rounded-lg overflow-hidden hover:bg-white/10 transition-all cursor-pointer group border border-white/20 hover:border-white/40" 
                     onclick="selectPexelsVideo('${video.id}', '${video.video_files[0].link}', '${video.user.name}')">
                    <div class="relative">
                        <video class="w-full h-24 object-cover" muted>
                            <source src="${video.video_files[0].link}" type="video/mp4">
                        </video>
                        <div class="absolute inset-0 bg-black/0 group-hover:bg-black/20 transition-colors flex items-center justify-center">
                            <i class="fas fa-play text-white opacity-0 group-hover:opacity-100 transition-opacity"></i>
                        </div>
                        <div class="absolute bottom-1 right-1 bg-black/50 text-white text-xs px-1 rounded">
                            ${Math.round(video.duration)}s
                        </div>
                    </div>
                    <div class="p-3">
                        <!-- Card limpo sem informa√ß√µes -->
                    </div>
                </div>
            `).join('');
        }

        // Select Pexels Video
        function selectPexelsVideo(videoId, videoUrl, author) {
            selectedVideo = {
                id: videoId,
                url: videoUrl,
                author: author,
                source: 'pexels'
            };
            
            console.log('üé¨ V√≠deo selecionado:', selectedVideo);
            
            // Remove previous selection
            document.querySelectorAll('.pexels-video-card').forEach(card => {
                card.classList.remove('ring-2', 'ring-orange-400', 'bg-orange-500/20');
            });
            
            // Add selection to clicked video
            const selectedCard = document.querySelector(`[onclick*="${videoId}"]`);
            if (selectedCard) {
                selectedCard.classList.add('ring-2', 'ring-orange-400', 'bg-orange-500/20');
            }
            
            // Update video preview
            displayVideoPreview();
        }

        // Save Video
        async function saveVideo() {
            if (!selectedVideo) {
                alert('Por favor, selecione um v√≠deo primeiro.');
                return;
            }

            try {
                // Coletar dados do formul√°rio
                const caption = document.getElementById('videoCaption').value;
                const captionFont = document.getElementById('videoCaptionFont').value;
                const videoSpeed = document.getElementById('videoSpeed').value;
                const videoFilter = document.getElementById('videoFilter').value;
                
                // Coletar dados da narra√ß√£o
                const narrationText = document.getElementById('narrationText').value;
                const selectedVoiceId = document.getElementById('voiceSelect').value;
                const narrationSpeed = document.getElementById('narrationSpeed').value;
                const narrationVolume = document.getElementById('narrationVolume').value;

                console.log('üíæ Salvando v√≠deo como post...');

                // 1. PRIMEIRO: Fazer upload do v√≠deo para URL persistente
                let persistentVideoUrl = null;
                
                if (selectedVideo && selectedVideo.url && selectedVideo.url.startsWith('blob:')) {
                    console.log('üì§ Convertendo blob para URL persistente...');
                    
                    // Converter blob para arquivo
                    const response = await fetch(selectedVideo.url);
                    const blob = await response.blob();
                    const file = new File([blob], 'video.mp4', { type: 'video/mp4' });
                    
                    // Upload para servidor
                    const uploadFormData = new FormData();
                    uploadFormData.append('video', file);
                    
                    const uploadResponse = await fetch('/api/upload-video', {
                        method: 'POST',
                        body: uploadFormData
                    });
                    
                    if (uploadResponse.ok) {
                        const uploadResult = await uploadResponse.json();
                        persistentVideoUrl = uploadResult.url;
                        console.log('‚úÖ V√≠deo convertido para URL persistente:', persistentVideoUrl);
                    } else {
                        console.error('‚ùå Erro ao converter v√≠deo:', await uploadResponse.text());
                        alert('Erro ao salvar v√≠deo. Tente novamente.');
                        return;
                    }
                } else if (selectedVideo && selectedVideo.url && !selectedVideo.url.startsWith('blob:')) {
                    // J√° √© uma URL persistente
                    persistentVideoUrl = selectedVideo.url;
                    console.log('‚úÖ V√≠deo j√° tem URL persistente:', persistentVideoUrl);
                } else {
                    console.error('‚ùå Nenhum v√≠deo v√°lido encontrado');
                    alert('Erro: Nenhum v√≠deo v√°lido encontrado.');
                    return;
                }

                // Preparar dados para envio
                const videoData = {
                    video: persistentVideoUrl,
                    caption: caption,
                    captionFont: captionFont,
                    speed: videoSpeed,
                    filter: videoFilter,
                    narration: {
                        text: narrationText,
                        voiceId: selectedVoiceId,
                        speed: narrationSpeed,
                        volume: narrationVolume,
                        audioBlob: window.generatedNarration ? 'generated' : null
                    },
                    timestamp: new Date().toISOString()
                };

                console.log('üíæ Dados do v√≠deo preparados:', videoData);

                // Criar post com v√≠deo
                const postData = {
                    title: 'Meu V√≠deo',
                    content: 'V√≠deo criado com legenda personalizada',
                    template: 'V√≠deo com Legenda',
                    hashtags: '#video #legenda #personalizado',
                    platforms: JSON.stringify(['instagram', 'facebook']),
                    customization: JSON.stringify({
                        video: persistentVideoUrl, // Usar URL persistente
                        videoCaption: caption,
                        videoCaptionFont: captionFont,
                        videoSpeed: videoSpeed,
                        videoFilter: videoFilter,
                        font: captionFont,
                        color: '#ffffff',
                        background: 'post-bg-video',
                        textEffect: 'normal',
                        // Adicionar dados da narra√ß√£o
                        narration: {
                            text: narrationText,
                            voiceId: selectedVoiceId,
                            speed: narrationSpeed,
                            volume: narrationVolume,
                            hasAudio: !!window.generatedNarration
                        }
                    })
                };

                console.log('üìù Dados do post:', postData);

                // Preparar FormData para incluir √°udio se existir
                const formData = new FormData();
                formData.append('title', postData.title);
                formData.append('content', postData.content);
                formData.append('template', postData.template);
                formData.append('hashtags', postData.hashtags);
                formData.append('platforms', postData.platforms);
                formData.append('customization', postData.customization);
                
                // Adicionar √°udio se foi gerado
                if (window.generatedNarration) {
                    console.log('üé§ Enviando √°udio da narra√ß√£o...');
                    formData.append('narrationAudio', window.generatedNarration, 'narration.mp3');
                }

                // Enviar para API
                const response = await fetch('/api/posts', {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    const result = await response.json();
                    console.log('‚úÖ Post com v√≠deo salvo:', result);
                    
                    // Salvar tamb√©m no localStorage para backup
                    const savedVideos = JSON.parse(localStorage.getItem('savedVideos') || '[]');
                    savedVideos.push(videoData);
                    localStorage.setItem('savedVideos', JSON.stringify(savedVideos));

                    alert('‚úÖ V√≠deo salvo como post! Voc√™ pode visualiz√°-lo na p√°gina de posts.');
                    
                    // Redirecionar para posts
                        window.location.href = '/posts';
                    } else {
                    const error = await response.text();
                    console.error('‚ùå Erro ao salvar post:', error);
                    alert('‚ùå Erro ao salvar o v√≠deo. Tente novamente.');
                }
                
            } catch (error) {
                console.error('‚ùå Erro ao salvar v√≠deo:', error);
                alert('Erro ao salvar v√≠deo. Tente novamente.');
            }
        }

        // Search on input
        document.getElementById('pexelsVideoSearch').addEventListener('input', function(e) {
            const query = e.target.value;
            if (query.length > 2 && pexelsManager) {
                searchPexelsVideos();
            }
        });
    </script>
</body>
</html>