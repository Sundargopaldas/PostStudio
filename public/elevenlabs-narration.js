/**
 * ElevenLabs Narration Manager
 * Sistema isolado para gerenciar narra√ß√£o com ElevenLabs
 */

class ElevenLabsNarration {
    constructor() {
        this.apiKey = null;
        this.voices = [];
        this.isInitialized = false;
        this.currentAudio = null;
    }

    /**
     * Inicializar o sistema de narra√ß√£o
     */
    async initialize() {
        try {
            console.log('üé§ Inicializando ElevenLabs Narration...');
            
            // Verificar se a API key est√° dispon√≠vel
            this.apiKey = await this.getApiKey();
            if (!this.apiKey) {
                throw new Error('API Key do ElevenLabs n√£o encontrada');
            }

            // Carregar vozes dispon√≠veis
            await this.loadVoices();
            
            this.isInitialized = true;
            console.log('‚úÖ ElevenLabs Narration inicializado com sucesso');
            return true;
        } catch (error) {
            console.error('‚ùå Erro ao inicializar ElevenLabs Narration:', error);
            return false;
        }
    }

    /**
     * Obter API key do ElevenLabs
     */
    async getApiKey() {
        try {
            // Tentar obter da configura√ß√£o do usu√°rio
            const response = await fetch('/api/user/settings');
            if (response.ok) {
                const settings = await response.json();
                return settings.elevenlabsApiKey;
            }
        } catch (error) {
            console.log('‚ö†Ô∏è N√£o foi poss√≠vel obter API key do servidor');
        }

        // Fallback para API key padr√£o (chave funcional)
        return 'sk_83361992bc2f7a4177040a338cad9964ce3bd9dd53d480e4';
    }

    /**
     * Carregar vozes dispon√≠veis
     */
    async loadVoices() {
        // SEMPRE usar vozes padr√£o para garantir funcionamento
        console.log('üé§ Carregando vozes padr√£o (modo offline)...');
        this.voices = this.getDefaultVoices();
        console.log(`‚úÖ ${this.voices.length} vozes padr√£o carregadas`);
        
        // Tentar carregar do ElevenLabs em background (opcional)
        this.loadVoicesFromAPI();
    }
    
    async loadVoicesFromAPI() {
        try {
            console.log('üîÑ Tentando carregar vozes do ElevenLabs em background...');
            
            const response = await fetch('https://api.elevenlabs.io/v1/voices', {
                headers: {
                    'xi-api-key': this.apiKey
                }
            });

            if (response.ok) {
                const data = await response.json();
                if (data.voices && data.voices.length > 0) {
                    this.voices = data.voices;
                    console.log(`‚úÖ ${this.voices.length} vozes do ElevenLabs carregadas em background`);
                }
            } else {
                console.log('‚ö†Ô∏è API ElevenLabs n√£o dispon√≠vel, mantendo vozes padr√£o');
            }
        } catch (error) {
            console.log('‚ö†Ô∏è Erro ao carregar do ElevenLabs, mantendo vozes padr√£o');
        }
    }

    /**
     * Obter vozes padr√£o caso a API falhe
     */
    getDefaultVoices() {
        return [
            { voice_id: '21m00Tcm4TlvDq8ikWAM', name: 'Rachel', category: 'premade' },
            { voice_id: 'AZnzlk1XvdvUeBnXmlld', name: 'Domi', category: 'premade' },
            { voice_id: 'EXAVITQu4vr4xnSDxMaL', name: 'Bella', category: 'premade' },
            { voice_id: 'ErXwobaYiN019PkySvjV', name: 'Antoni', category: 'premade' },
            { voice_id: 'MF3mGyEYCl7XYWbV9V6O', name: 'Elli', category: 'premade' },
            { voice_id: 'TxGEqnHWrfWFTfGW9XjX', name: 'Josh', category: 'premade' },
            { voice_id: 'VR6AewLTigWG4xSOukaG', name: 'Arnold', category: 'premade' },
            { voice_id: 'pNInz6obpgDQGcFmaJgB', name: 'Adam', category: 'premade' },
            { voice_id: 'yoZ06aMxZJJ28mfd3POQ', name: 'Sam', category: 'premade' }
        ];
    }

    /**
     * Gerar narra√ß√£o de texto
     */
    async generateNarration(text, voiceId, options = {}) {
        if (!this.isInitialized) {
            throw new Error('ElevenLabs Narration n√£o foi inicializado');
        }

        if (!text || text.trim() === '') {
            throw new Error('Texto n√£o pode estar vazio');
        }

        try {
            console.log('üé§ Gerando narra√ß√£o...', { text: text.substring(0, 50) + '...', voiceId });

            const requestBody = {
                text: text,
                model_id: 'eleven_multilingual_v2',
                voice_settings: {
                    stability: options.stability || 0.5,
                    similarity_boost: options.similarityBoost || 0.5,
                    style: options.style || 0.0,
                    use_speaker_boost: options.useSpeakerBoost || true
                }
            };

            const response = await fetch(`https://api.elevenlabs.io/v1/text-to-speech/${voiceId}`, {
                method: 'POST',
                headers: {
                    'Accept': 'audio/mpeg',
                    'Content-Type': 'application/json',
                    'xi-api-key': this.apiKey
                },
                body: JSON.stringify(requestBody)
            });

            if (response.ok) {
                const audioBlob = await response.blob();
                const audioUrl = URL.createObjectURL(audioBlob);
                
                console.log('‚úÖ Narra√ß√£o gerada com sucesso');
                return {
                    success: true,
                    audioUrl: audioUrl,
                    audioBlob: audioBlob,
                    duration: await this.getAudioDuration(audioUrl)
                };
            } else {
                const errorData = await response.json();
                throw new Error(`Erro na API: ${errorData.detail || 'Erro desconhecido'}`);
            }
        } catch (error) {
            console.error('‚ùå Erro ao gerar narra√ß√£o:', error);
            throw error;
        }
    }

    /**
     * Obter dura√ß√£o do √°udio
     */
    async getAudioDuration(audioUrl) {
        return new Promise((resolve) => {
            const audio = new Audio(audioUrl);
            audio.addEventListener('loadedmetadata', () => {
                resolve(audio.duration);
            });
            audio.addEventListener('error', () => {
                resolve(0);
            });
        });
    }

    /**
     * Reproduzir narra√ß√£o
     */
    async playNarration(audioUrl) {
        try {
            // Parar √°udio atual se estiver tocando
            if (this.currentAudio) {
                this.currentAudio.pause();
                this.currentAudio = null;
            }

            const audio = new Audio(audioUrl);
            this.currentAudio = audio;
            
            await audio.play();
            console.log('üéµ Narra√ß√£o reproduzida');
            return true;
        } catch (error) {
            console.error('‚ùå Erro ao reproduzir narra√ß√£o:', error);
            return false;
        }
    }

    /**
     * Parar narra√ß√£o atual
     */
    stopNarration() {
        if (this.currentAudio) {
            this.currentAudio.pause();
            this.currentAudio = null;
            console.log('‚èπÔ∏è Narra√ß√£o parada');
        }
    }

    /**
     * Baixar narra√ß√£o como arquivo
     */
    downloadNarration(audioBlob, filename = 'narracao.mp3') {
        try {
            const url = URL.createObjectURL(audioBlob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            console.log('üíæ Narra√ß√£o baixada');
        } catch (error) {
            console.error('‚ùå Erro ao baixar narra√ß√£o:', error);
        }
    }

    /**
     * Criar v√≠deo com narra√ß√£o
     */
    async createVideoWithNarration(videoElement, audioUrl, captionText = '', captionOptions = {}) {
        try {
            console.log('üé¨ Criando v√≠deo com narra√ß√£o...');

            // Configurar v√≠deo
            videoElement.muted = false;
            videoElement.volume = 0.8;

            // Criar elemento de √°udio para narra√ß√£o
            const narrationAudio = new Audio(audioUrl);
            narrationAudio.volume = 0.9;

            // Sincronizar √°udio com v√≠deo
            const syncAudio = () => {
                if (!videoElement.paused) {
                    narrationAudio.currentTime = videoElement.currentTime;
                    if (narrationAudio.paused) {
                        narrationAudio.play();
                    }
                } else {
                    narrationAudio.pause();
                }
            };

            // Event listeners para sincroniza√ß√£o
            videoElement.addEventListener('play', () => {
                narrationAudio.play();
                syncAudio();
            });

            videoElement.addEventListener('pause', () => {
                narrationAudio.pause();
            });

            videoElement.addEventListener('timeupdate', syncAudio);

            // Adicionar legendas se especificado
            if (captionText) {
                this.addCaptionsToVideo(videoElement, captionText, captionOptions);
            }

            console.log('‚úÖ V√≠deo com narra√ß√£o configurado');
            return true;
        } catch (error) {
            console.error('‚ùå Erro ao criar v√≠deo com narra√ß√£o:', error);
            return false;
        }
    }

    /**
     * Adicionar legendas ao v√≠deo
     */
    addCaptionsToVideo(videoElement, captionText, options = {}) {
        const container = videoElement.parentElement;
        if (!container) return;

        // Remover legendas existentes
        const existingCaption = container.querySelector('.narration-caption');
        if (existingCaption) {
            existingCaption.remove();
        }

        // Criar elemento de legenda
        const captionElement = document.createElement('div');
        captionElement.className = 'narration-caption';
        captionElement.style.cssText = `
            position: absolute;
            ${options.position || 'bottom'}: 1rem;
            left: 1rem;
            right: 1rem;
            background: rgba(0, 0, 0, 0.8);
            color: ${options.color || 'white'};
            padding: 1rem;
            border-radius: 0.5rem;
            text-align: center;
            font-family: ${options.font || 'Arial'};
            font-size: ${options.fontSize || '1rem'};
            z-index: 10;
            display: none;
        `;
        captionElement.textContent = captionText;

        container.appendChild(captionElement);

        // Mostrar legenda quando o v√≠deo come√ßar
        videoElement.addEventListener('play', () => {
            captionElement.style.display = 'block';
            this.animateCaption(captionElement, captionText);
        });

        videoElement.addEventListener('pause', () => {
            captionElement.style.display = 'none';
        });
    }

    /**
     * Animar legenda
     */
    animateCaption(element, text) {
        element.textContent = '';
        const words = text.split(' ');
        let currentIndex = 0;

        const showNextWord = () => {
            if (currentIndex < words.length) {
                element.textContent += (currentIndex > 0 ? ' ' : '') + words[currentIndex];
                currentIndex++;
                setTimeout(showNextWord, 200);
            }
        };

        showNextWord();
    }

    /**
     * Obter vozes dispon√≠veis
     */
    getVoices() {
        return this.voices;
    }

    /**
     * Verificar se est√° inicializado
     */
    isReady() {
        return this.isInitialized;
    }

    /**
     * Obter status do sistema
     */
    getStatus() {
        return {
            initialized: this.isInitialized,
            voicesCount: this.voices.length,
            apiKey: this.apiKey ? 'Configurada' : 'N√£o configurada'
        };
    }
}

// Inst√¢ncia global
window.ElevenLabsNarration = new ElevenLabsNarration();

// Auto-inicializar quando o DOM estiver pronto
document.addEventListener('DOMContentLoaded', async () => {
    console.log('üöÄ Inicializando ElevenLabs Narration...');
    await window.ElevenLabsNarration.initialize();
});

// Exportar para uso em outros m√≥dulos
if (typeof module !== 'undefined' && module.exports) {
    module.exports = ElevenLabsNarration;
}
